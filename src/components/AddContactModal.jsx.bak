import React, { useState, useEffect, useRef } from 'react';

import { INDIAN_LOCATION_HIERARCHY } from '../data/detailedLocationData';
import { LOCATION_DATA } from '../data/locationData';
import { PROPERTY_CATEGORIES } from '../data/propertyData';

// Simple Custom Multi-Select Component
const CustomMultiSelect = ({ options, value, onChange, placeholder, disabled }) => {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef(null);

    useEffect(() => {
        function handleClickOutside(event) {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const toggleOption = (option) => {
        const newValue = value.includes(option)
            ? value.filter(v => v !== option)
            : [...value, option];
        onChange(newValue);
    };

    return (
        <div ref={containerRef} style={{ position: 'relative' }}>
            <div
                onClick={() => !disabled && setIsOpen(!isOpen)}
                style={{
                    width: '100%',
                    padding: '8px 12px',
                    borderRadius: '6px',
                    border: '1px solid #e2e8f0',
                    fontSize: '0.9rem',
                    color: '#334155',
                    outline: 'none',
                    transition: 'border-color 0.2s',
                    background: disabled ? '#f8fafc' : '#fff',
                    cursor: disabled ? 'not-allowed' : 'pointer',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    minHeight: '40px'
                }}
            >
                <div style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', marginRight: '8px' }}>
                    {value.length > 0 ? value.join(', ') : <span style={{ color: '#94a3b8' }}>{placeholder}</span>}
                </div>
                <i className={`fas fa-chevron-down ${isOpen ? 'fa-rotate-180' : ''}`} style={{ color: '#94a3b8', transition: 'transform 0.2s', fontSize: '0.8rem' }}></i>
            </div>

            {isOpen && !disabled && (
                <div style={{ position: 'absolute', top: '100%', left: 0, right: 0, background: '#fff', border: '1px solid #e2e8f0', borderRadius: '6px', marginTop: '4px', zIndex: 50, maxHeight: '220px', overflowY: 'auto', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}>
                    {options.length > 0 ? options.map(opt => (
                        <div
                            key={opt}
                            onClick={() => toggleOption(opt)}
                            style={{
                                padding: '10px 12px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                borderBottom: '1px solid #f1f5f9',
                                background: value.includes(opt) ? '#f8fafc' : '#fff'
                            }}
                            className="hover:bg-slate-50"
                        >
                            <input
                                type="checkbox"
                                checked={value.includes(opt)}
                                readOnly
                                style={{ width: '14px', height: '14px', cursor: 'pointer' }}
                            />
                            <span style={{ fontSize: '0.9rem', color: '#334155' }}>{opt}</span>
                        </div>
                    )) : (
                        <div style={{ padding: '12px', textAlign: 'center', color: '#94a3b8', fontSize: '0.85rem' }}>No options available</div>
                    )}
                </div>
            )}
        </div>
    );
};

const COUNTRY_CODES = [


    { name: 'India', dial_code: '+91', code: 'IN' },
    { name: 'United States', dial_code: '+1', code: 'US' },
    { name: 'United Kingdom', dial_code: '+44', code: 'GB' },
    { name: 'Afghanistan', dial_code: '+93', code: 'AF' },
    { name: 'Albania', dial_code: '+355', code: 'AL' },
    { name: 'Algeria', dial_code: '+213', code: 'DZ' },
    { name: 'Andorra', dial_code: '+376', code: 'AD' },
    { name: 'Angola', dial_code: '+244', code: 'AO' },
    { name: 'Argentina', dial_code: '+54', code: 'AR' },
    { name: 'Armenia', dial_code: '+374', code: 'AM' },
    { name: 'Australia', dial_code: '+61', code: 'AU' },
    { name: 'Austria', dial_code: '+43', code: 'AT' },
    { name: 'Azerbaijan', dial_code: '+994', code: 'AZ' },
    { name: 'Bahrain', dial_code: '+973', code: 'BH' },
    { name: 'Bangladesh', dial_code: '+880', code: 'BD' },
    { name: 'Belarus', dial_code: '+375', code: 'BY' },
    { name: 'Belgium', dial_code: '+32', code: 'BE' },
    { name: 'Bhutan', dial_code: '+975', code: 'BT' },
    { name: 'Bolivia', dial_code: '+591', code: 'BO' },
    { name: 'Bosnia and Herzegovina', dial_code: '+387', code: 'BA' },
    { name: 'Brazil', dial_code: '+55', code: 'BR' },
    { name: 'Bulgaria', dial_code: '+359', code: 'BG' },
    { name: 'Cambodia', dial_code: '+855', code: 'KH' },
    { name: 'Canada', dial_code: '+1', code: 'CA' },
    { name: 'Chile', dial_code: '+56', code: 'CL' },
    { name: 'China', dial_code: '+86', code: 'CN' },
    { name: 'Colombia', dial_code: '+57', code: 'CO' },
    { name: 'Costa Rica', dial_code: '+506', code: 'CR' },
    { name: 'Croatia', dial_code: '+385', code: 'HR' },
    { name: 'Cuba', dial_code: '+53', code: 'CU' },
    { name: 'Cyprus', dial_code: '+357', code: 'CY' },
    { name: 'Czech Republic', dial_code: '+420', code: 'CZ' },
    { name: 'Denmark', dial_code: '+45', code: 'DK' },
    { name: 'Egypt', dial_code: '+20', code: 'EG' },
    { name: 'Estonia', dial_code: '+372', code: 'EE' },
    { name: 'Ethiopia', dial_code: '+251', code: 'ET' },
    { name: 'Finland', dial_code: '+358', code: 'FI' },
    { name: 'France', dial_code: '+33', code: 'FR' },
    { name: 'Georgia', dial_code: '+995', code: 'GE' },
    { name: 'Germany', dial_code: '+49', code: 'DE' },
    { name: 'Greece', dial_code: '+30', code: 'GR' },
    { name: 'Hong Kong', dial_code: '+852', code: 'HK' },
    { name: 'Hungary', dial_code: '+36', code: 'HU' },
    { name: 'Iceland', dial_code: '+354', code: 'IS' },
    { name: 'Indonesia', dial_code: '+62', code: 'ID' },
    { name: 'Iran', dial_code: '+98', code: 'IR' },
    { name: 'Iraq', dial_code: '+964', code: 'IQ' },
    { name: 'Ireland', dial_code: '+353', code: 'IE' },
    { name: 'Israel', dial_code: '+972', code: 'IL' },
    { name: 'Italy', dial_code: '+39', code: 'IT' },
    { name: 'Japan', dial_code: '+81', code: 'JP' },
    { name: 'Jordan', dial_code: '+962', code: 'JO' },
    { name: 'Kazakhstan', dial_code: '+7', code: 'KZ' },
    { name: 'Kenya', dial_code: '+254', code: 'KE' },
    { name: 'Kuwait', dial_code: '+965', code: 'KW' },
    { name: 'Kyrgyzstan', dial_code: '+996', code: 'KG' },
    { name: 'Latvia', dial_code: '+371', code: 'LV' },
    { name: 'Lebanon', dial_code: '+961', code: 'LB' },
    { name: 'Libya', dial_code: '+218', code: 'LY' },
    { name: 'Liechtenstein', dial_code: '+423', code: 'LI' },
    { name: 'Lithuania', dial_code: '+370', code: 'LT' },
    { name: 'Luxembourg', dial_code: '+352', code: 'LU' },
    { name: 'Malaysia', dial_code: '+60', code: 'MY' },
    { name: 'Maldives', dial_code: '+960', code: 'MV' },
    { name: 'Mexico', dial_code: '+52', code: 'MX' },
    { name: 'Monaco', dial_code: '+377', code: 'MC' },
    { name: 'Mongolia', dial_code: '+976', code: 'MN' },
    { name: 'Montenegro', dial_code: '+382', code: 'ME' },
    { name: 'Morocco', dial_code: '+212', code: 'MA' },
    { name: 'Myanmar', dial_code: '+95', code: 'MM' },
    { name: 'Nepal', dial_code: '+977', code: 'NP' },
    { name: 'Netherlands', dial_code: '+31', code: 'NL' },
    { name: 'New Zealand', dial_code: '+64', code: 'NZ' },
    { name: 'North Korea', dial_code: '+850', code: 'KP' },
    { name: 'Norway', dial_code: '+47', code: 'NO' },
    { name: 'Oman', dial_code: '+968', code: 'OM' },
    { name: 'Pakistan', dial_code: '+92', code: 'PK' },
    { name: 'Peru', dial_code: '+51', code: 'PE' },
    { name: 'Philippines', dial_code: '+63', code: 'PH' },
    { name: 'Poland', dial_code: '+48', code: 'PL' },
    { name: 'Portugal', dial_code: '+351', code: 'PT' },
    { name: 'Qatar', dial_code: '+974', code: 'QA' },
    { name: 'Romania', dial_code: '+40', code: 'RO' },
    { name: 'Russia', dial_code: '+7', code: 'RU' },
    { name: 'Saudi Arabia', dial_code: '+966', code: 'SA' },
    { name: 'Serbia', dial_code: '+381', code: 'RS' },
    { name: 'Singapore', dial_code: '+65', code: 'SG' },
    { name: 'Slovakia', dial_code: '+421', code: 'SK' },
    { name: 'Slovenia', dial_code: '+386', code: 'SI' },
    { name: 'South Africa', dial_code: '+27', code: 'ZA' },
    { name: 'South Korea', dial_code: '+82', code: 'KR' },
    { name: 'Spain', dial_code: '+34', code: 'ES' },
    { name: 'Sri Lanka', dial_code: '+94', code: 'LK' },
    { name: 'Sweden', dial_code: '+46', code: 'SE' },
    { name: 'Switzerland', dial_code: '+41', code: 'CH' },
    { name: 'Taiwan', dial_code: '+886', code: 'TW' },
    { name: 'Tajikistan', dial_code: '+992', code: 'TJ' },
    { name: 'Thailand', dial_code: '+66', code: 'TH' },
    { name: 'Turkey', dial_code: '+90', code: 'TR' },
    { name: 'Ukraine', dial_code: '+380', code: 'UA' },
    { name: 'United Arab Emirates', dial_code: '+971', code: 'AE' },
    { name: 'Uzbekistan', dial_code: '+998', code: 'UZ' },
    { name: 'Venezuela', dial_code: '+58', code: 'VE' },
    { name: 'Vietnam', dial_code: '+84', code: 'VN' },
    { name: 'Yemen', dial_code: '+967', code: 'YE' },
    { name: 'Zambia', dial_code: '+260', code: 'ZM' },
    { name: 'Zimbabwe', dial_code: '+263', code: 'ZW' },
];

const STAGES = ['New', 'Contacted', 'Interested', 'Meeting Scheduled', 'Negotiation', 'Qualified', 'Won', 'Lost'];
const STATUSES = ['Active', 'Inactive', 'Pending', 'Closed'];
const SOURCES = ['Website', 'Referral', 'Social Media', 'Direct', 'Other', 'Cold Call', 'Walk-in'];

// Mock Contacts for Duplicate Check
const MOCK_CONTACTS = [
    {
        title: 'Mr.', name: 'Amit Kumar', surname: 'Sharma',
        company: 'Bharat Properties',
        phones: [{ phoneCode: '+91', phoneNumber: '9876543210' }],
        emails: ['amit.k@example.com'],
        personalAddress: { city: 'New Delhi', state: 'Delhi' }
    },
    {
        title: 'Ms.', name: 'Priya Singh', surname: 'Verma',
        company: 'Tech Solutions',
        phones: [{ phoneCode: '+91', phoneNumber: '9988776655' }],
        emails: ['priya.s@tech.com'],
        personalAddress: { city: 'Mumbai', state: 'Maharashtra' }
    },
    {
        title: 'Dr.', name: 'Rahul Gupta', surname: '',
        company: 'City Hospital',
        phones: [{ phoneCode: '+91', phoneNumber: '8877665544' }],
        emails: ['dr.rahul@hospital.com'],
        personalAddress: { city: 'Bangalore', state: 'Karnataka' }
    },
    {
        title: 'Mrs.', name: 'Sneha Patel', surname: '',
        company: 'Creative Design',
        phones: [{ phoneCode: '+91', phoneNumber: '7766554433' }],
        emails: ['sneha.design@example.com'],
        personalAddress: { city: 'Ahmedabad', state: 'Gujarat' }
    },
    {
        title: 'Mr.', name: 'Vikram Singh', surname: 'Rathore',
        company: 'Real Estate Co',
        phones: [{ phoneCode: '+91', phoneNumber: '9123456789' }],
        emails: ['vikram.r@realestate.com'],
        personalAddress: { city: 'Jaipur', state: 'Rajasthan' }
    }
];

const companyList = [
    'Bharat Properties',
    'Tech Solutions',
    'City Hospital',
    'Creative Design',
    'Real Estate Co',
    'Alpha Corp',
    'Beta Industries'
];

// Duplicate Popup Component (Restyled for Side Panel)
const DuplicateResults = ({ contacts, onUpdate }) => {
    if (!contacts || contacts.length === 0) {
        return (
            <div style={{
                padding: '40px 20px',
                textAlign: 'center',
                color: '#94a3b8',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '12px'
            }}>
                <div style={{
                    width: '48px',
                    height: '48px',
                    background: '#f1f5f9',
                    borderRadius: '50%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#cbd5e1'
                }}>
                    <i className="fas fa-search" style={{ fontSize: '1.2rem' }}></i>
                </div>
                <div>
                    <h4 style={{ margin: '0 0 4px 0', fontSize: '0.95rem', color: '#64748b' }}>No Duplicates</h4>
                    <p style={{ margin: 0, fontSize: '0.8rem' }}>Similar contacts will appear here</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', padding: '16px' }}>
            <div style={{
                padding: '8px 12px',
                background: '#e0f2fe',
                borderRadius: '6px',
                border: '1px solid #bae6fd',
                fontSize: '0.8rem',
                fontWeight: 600,
                color: '#0369a1',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
            }}>
                <i className="fas fa-exclamation-circle"></i>
                {contacts.length} Similar Contact{contacts.length > 1 ? 's' : ''} Found
            </div>
            {contacts.map((contact, index) => (
                <div key={index} style={{
                    background: '#fff',
                    borderRadius: '8px',
                    border: '1px solid #e2e8f0',
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.05)',
                    padding: '12px',
                    transition: 'transform 0.2s',
                    ':hover': { transform: 'translateY(-2px)' }
                }}>
                    <div style={{ fontWeight: 700, color: '#0f172a', fontSize: '0.95rem', marginBottom: '4px' }}>
                        {contact.title} {contact.name} {contact.surname}
                    </div>
                    {contact.company && (
                        <div style={{ fontSize: '0.8rem', color: '#64748b', marginBottom: '8px' }}>
                            <i className="fas fa-building" style={{ width: '16px' }}></i> {contact.company}
                        </div>
                    )}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginBottom: '12px' }}>
                        {contact.phones?.[0] && (
                            <div style={{ fontSize: '0.8rem', color: '#475569', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <i className="fas fa-phone" style={{ fontSize: '0.7rem', color: '#94a3b8' }}></i>
                                {contact.phones[0].phoneNumber}
                            </div>
                        )}
                        {contact.emails?.[0] && (
                            <div style={{ fontSize: '0.8rem', color: '#475569', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <i className="fas fa-envelope" style={{ fontSize: '0.7rem', color: '#94a3b8' }}></i>
                                {contact.emails[0]}
                            </div>
                        )}
                    </div>
                    <button
                        type="button"
                        onClick={(e) => { e.preventDefault(); onUpdate(contact); }}
                        style={{
                            width: '100%',
                            padding: '8px',
                            background: '#eff6ff',
                            border: '1px solid #3b82f6',
                            color: '#2563eb',
                            borderRadius: '6px',
                            fontSize: '0.8rem',
                            fontWeight: 600,
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '6px',
                            transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.background = '#3b82f6';
                            e.target.style.color = '#fff';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.background = '#eff6ff';
                            e.target.style.color = '#2563eb';
                        }}
                    >
                        <i className="fas fa-sync-alt"></i> Update Form with this
                    </button>
                </div>
            ))}
        </div>
    );
};

// --- Animated UI Components ---

const AnimatedSegmentControl = ({ options, value, onChange }) => {
    const [activeIndex, setActiveIndex] = useState(options.indexOf(value));

    useEffect(() => {
        setActiveIndex(options.indexOf(value));
    }, [value, options]);

    const handleSelect = (option, index) => {
        setActiveIndex(index);
        onChange(option);
    };

    return (
        <div style={{
            position: 'relative',
            display: 'flex',
            background: '#f1f5f9',
            borderRadius: '12px',
            padding: '4px',
            border: '1px solid #e2e8f0',
            height: '48px',
            isolation: 'isolate'
        }}>
            <div style={{
                position: 'absolute',
                top: '4px',
                bottom: '4px',
                left: `calc(${activeIndex * (100 / options.length)}% + 4px)`,
                width: `calc(${100 / options.length}% - 8px)`,
                background: '#fff',
                borderRadius: '8px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04)',
                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                zIndex: 1
            }} />

            {options.map((option, index) => (
                <button
                    key={option}
                    type="button"
                    onClick={() => handleSelect(option, index)}
                    style={{
                        flex: 1,
                        position: 'relative',
                        zIndex: 2,
                        background: 'transparent',
                        border: 'none',
                        fontSize: '0.95rem',
                        fontWeight: value === option ? 600 : 500,
                        color: value === option ? '#0f172a' : '#64748b',
                        cursor: 'pointer',
                        transition: 'color 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}
                >
                    {option}
                </button>
            ))}
        </div>
    );
};

const AnimatedChipGroup = ({ options, value, onChange }) => {
    const toggleOption = (option) => {
        const newValue = value.includes(option)
            ? value.filter(v => v !== option)
            : [...value, option];
        onChange(newValue);
    };

    return (
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
            {options.map(option => {
                const isActive = value.includes(option);
                return (
                    <button
                        key={option}
                        type="button"
                        onClick={() => toggleOption(option)}
                        style={{
                            padding: '8px 16px',
                            borderRadius: '24px',
                            border: isActive ? '1px solid #3b82f6' : '1px solid #e2e8f0',
                            background: isActive ? '#eff6ff' : '#fff',
                            color: isActive ? '#2563eb' : '#64748b',
                            fontSize: '0.9rem',
                            fontWeight: isActive ? 600 : 500,
                            cursor: 'pointer',
                            transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)',
                            transform: isActive ? 'scale(1.05)' : 'scale(1)',
                            boxShadow: isActive ? '0 2px 4px rgba(59, 130, 246, 0.15)' : 'none',
                            outline: 'none'
                        }}
                    >
                        {option}
                    </button>
                );
            })}
        </div>
    );
};

const AddContactModal = ({ isOpen, onClose, onAdd, initialData, mode = 'add', entityType = 'contact' }) => {
    const [currentTab, setCurrentTab] = useState(entityType === 'lead' ? 'requirement' : 'basic');
    const [currentAddressType, setCurrentAddressType] = useState('permanent'); // permanent or correspondence
    const [showOnlyRequired, setShowOnlyRequired] = useState(false);

    // Company Logic
    const [companyList, setCompanyList] = useState(['Company A', 'Company B', 'Bharat Properties']);
    const [showCompanyDropdown, setShowCompanyDropdown] = useState(false);
    const [companySearch, setCompanySearch] = useState('');

    // Document Name Logic
    const [documentNameList, setDocumentNameList] = useState(['ID Proof', 'Address Proof', 'Other']);
    const [activeDocumentSearchIndex, setActiveDocumentSearchIndex] = useState(null);
    const [documentSearchTerm, setDocumentSearchTerm] = useState('');

    // Pre-fill Logic
    useEffect(() => {
        if (isOpen && mode === 'edit' && initialData) {
            // Function to parse address string back to object parts (approximation)
            // Ideally we should store address parts in DB, but for now we try to parse or just leave blank if complex
            // Since we updated App.jsx to join address with commas, simple split might work if structure is strictly followed.
            // BETTER APPROACH: Use data if we had it as separate fields in initialData object.
            // Since mock data only has 'address' string, we might lose accuracy on edit unless we change data strategy.
            // BUT, for this task, user wants pre-fill. If we only have string, we can't perfectly reverse it to cascading dropdowns easily without complex parsing.
            // However, the prompt says "ab aap same ye hi add contact form ko...".
            // Assumption: for the sake of this demo, we will try to map what we can.
            // Wait! The user just added a contact with FULL details. So if we edit THAT contact, we can theoretically rely on the fact that we have the data...
            // EXCEPT our contactData only stores the flattened string 'address'.
            // ERROR: We lost the granular address data in handleSaveContact in App.jsx!
            // FIX: We need to store granular address data in contact object in App.jsx or we can't edit it back perfectly.
            // Let's assume for now we just fill Name, Mobile, Email etc. mapping back address string to fields is hard.
            // actually, let's parse the name.

            const nameParts = initialData.name.split(' ');
            let title = '';
            let name = '';
            let surname = '';

            if (['Mr.', 'Ms.', 'Mrs.', 'Dr.'].includes(nameParts[0])) {
                title = nameParts[0];
                name = nameParts.slice(1, -1).join(' '); // middle parts
                surname = nameParts[nameParts.length - 1];
            } else {
                name = nameParts.slice(0, -1).join(' ');
                surname = nameParts[nameParts.length - 1];
            }

            // Simplified for single name
            if (!surname) {
                name = initialData.name;
                surname = '';
            }

            setFormData(prev => ({
                ...prev,
                title: title,
                name: name,
                surname: surname,
                phones: [{ number: initialData.mobile, type: 'Personal' }],
                emails: [{ address: initialData.email, type: 'Personal' }],
                company: initialData.company,
                designation: initialData.designation,
                professionCategory: initialData.professional,
                // We leave address blank or simple because reversing the string 'H.No 12, Sector 4...' back to state/city/tehsil dropdowns is error prone without the raw ID objects.
                // Unless we update App.jsx to store the raw address object too.
                // For this step, I will map what is robust.
            }));
        } else if (isOpen && mode === 'add') {
            // Reset form on open add
            setFormData({
                title: '', name: '', surname: '', countryCode: '+91',
                phones: [{ number: '', type: 'Personal' }],
                emails: [{ address: '', type: 'Personal' }],
                tags: [], description: '',
                professionCategory: '', professionSubCategory: '',
                designation: '', company: '',
                source: '', team: '', owner: '', visibleTo: '',
                personalAddress: { hNo: '', country: '', state: '', city: '', tehsil: '', postOffice: '', pinCode: '', location: '', area: '' },
                correspondenceAddress: { hNo: '', country: '', state: '', city: '', tehsil: '', postOffice: '', pinCode: '', location: '', area: '' },
                gender: '', maritalStatus: '', birthDate: '', anniversaryDate: '',
                educations: [{ education: '', degree: '', school: '' }],
                loans: [{ loanType: '', bank: '', loanAmount: '' }],
                socialMedia: [{ platform: '', url: '' }],
                incomes: [{ incomeType: '', amount: '' }],
                documents: [{ documentName: '', documentNumber: '', documentPicture: null }],
            });
        }
    }, [isOpen, mode, initialData]);

    const handleDocumentNameSelect = (index, name) => {
        handleDocumentChange(index, 'documentName', name);
        setActiveDocumentSearchIndex(null);
        setDocumentSearchTerm('');
    };

    const handleDocumentNameAdd = (index) => {
        if (documentSearchTerm && !documentNameList.includes(documentSearchTerm)) {
            setDocumentNameList([...documentNameList, documentSearchTerm]);
            handleDocumentChange(index, 'documentName', documentSearchTerm);
            setActiveDocumentSearchIndex(null);
            setDocumentSearchTerm('');
        }
    };

    // Close dropdowns on outside click
    const companyDropdownRef = React.useRef(null);
    const documentDropdownRef = React.useRef(null);



    React.useEffect(() => {
        function handleClickOutside(event) {
            if (companyDropdownRef.current && !companyDropdownRef.current.contains(event.target)) {
                setShowCompanyDropdown(false);
            }
            if (documentDropdownRef.current && !documentDropdownRef.current.contains(event.target)) {
                setActiveDocumentSearchIndex(null);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, []);
    const [tagInput, setTagInput] = useState('');

    // Clock Logic
    const [currentTime, setCurrentTime] = useState(new Date());

    useEffect(() => {
        const timer = setInterval(() => {
            setCurrentTime(new Date());
        }, 1000);
        return () => clearInterval(timer);
    }, []);

    const searchInputRef = useRef(null);

    useEffect(() => {
        if (locationTab === 'search' && searchInputRef.current && window.google) {
            const autocomplete = new window.google.maps.places.Autocomplete(searchInputRef.current, {
                types: ['geocode'],
                fields: ['address_components', 'geometry', 'formatted_address']
            });

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    console.log("Returned place contains no geometry");
                    return;
                }

                const addressComponents = place.address_components;
                let streetParts = [];
                let city = '', state = '', country = '', zipcode = '', area = '';

                if (addressComponents) {
                    addressComponents.forEach(component => {
                        const types = component.types;
                        if (types.includes('street_number')) {
                            streetParts.push(component.long_name);
                        }
                        if (types.includes('route')) {
                            streetParts.push(component.long_name);
                        }
                        if (types.includes('subpremise')) {
                            streetParts.unshift(component.long_name); // Apartment/Unit number
                        }
                        if (types.includes('premise')) {
                            streetParts.push(component.long_name); // Building name
                        }
                        if (types.includes('neighborhood')) {
                            streetParts.push(component.long_name);
                        }
                        // Other potential "refined" address parts
                        if (types.includes('landmark') || types.includes('point_of_interest') || types.includes('establishment')) {
                            streetParts.push(component.long_name);
                        }

                        if (types.includes('locality')) {
                            city = component.long_name;
                        }
                        if (types.includes('sublocality') || types.includes('sublocality_level_1')) {
                            area = component.long_name;
                        }
                        if (types.includes('administrative_area_level_1')) {
                            state = component.long_name;
                        }
                        if (types.includes('country')) {
                            country = component.long_name;
                        }
                        if (types.includes('postal_code')) {
                            zipcode = component.long_name;
                        }
                    });
                }

                setFormData(prev => ({
                    ...prev,
                    searchLocation: place.formatted_address,
                    streetAddress: streetParts.join(', '), // Comma separated for "Road, Street, etc."
                    locCity: city,
                    locArea: area,
                    // locBlock: block, // Block field removed from UI, keeping state update minimal or removing if desired.
                    locState: state,
                    locCountry: country,
                    locPinCode: zipcode,
                    locLat: place.geometry.location.lat(),
                    locLng: place.geometry.location.lng()
                }));
            });
        }
    }, [currentTab, locationTab]);

    // Add state for Location Tab toggle
    const [locationTab, setLocationTab] = useState('select'); // 'select' or 'search'
    const [showSpecificUnit, setShowSpecificUnit] = useState(false);


    const [formData, setFormData] = useState({
        // Basic Details
        title: '',
        name: '',
        surname: '',
        countryCode: '+91',
        phones: [{ number: '', type: 'Personal' }],
        emails: [{ address: '', type: 'Personal' }],
        tags: [],
        description: '',

        // Professional Details
        professionCategory: '',
        professionSubCategory: '',
        designation: '',
        company: '',

        // System Details
        source: '',
        subSource: '', // Added for Leads
        campaign: '', // Added for Leads
        team: '',
        owner: '',
        visibleTo: '',

        // Requirement Details (Lead Specific)
        requirement: 'Buy',
        propertyType: ['Residential'],
        purpose: 'End use',
        nri: false,
        subType: [],
        unitType: [],
        budgetMin: '',
        budgetMax: '',
        areaMin: '',
        areaMax: '',
        areaMetric: 'Sq Yard',
        searchLocation: '',
        streetAddress: '',
        range: 'Within 3 km',
        locCity: '', locArea: '', locBlock: [], locPinCode: '',
        locCountry: '', locState: '', locLat: '', locLng: '',
        facing: [],
        roadWidth: [],
        direction: [],
        funding: '',
        timeline: '',
        furnishing: '',
        propertyUnitType: [],
        transactionType: '',
        transactionFlexiblePercent: 50,
        sendMatchedDeal: [],

        // Select Location Fields
        projectName: [],
        specificUnitType: 'single', // 'single' or 'row'
        propertyNo: '',
        propertyNoEnd: '',

        // Personal Address
        personalAddress: {
            hNo: '',
            country: '',
            state: '',
            city: '',
            tehsil: '',
            postOffice: '',
            pinCode: '',
            location: '',
            area: ''
        },

        // Correspondence Address
        correspondenceAddress: {
            hNo: '',
            country: '',
            state: '',
            city: '',
            tehsil: '',
            postOffice: '',
            pinCode: '',
            location: '',
            area: ''
        },

        // Other Details
        gender: '',
        maritalStatus: '',
        birthDate: '',
        anniversaryDate: '',

        // Education - Array
        educations: [{ education: '', degree: '', school: '' }],

        // Loan - Array
        loans: [{ loanType: '', bank: '', loanAmount: '' }],

        // Social Media - Array
        socialMedia: [{ platform: '', url: '' }],

        // Income - Array  
        incomes: [{ incomeType: '', amount: '' }],

        // Document - Array
        documents: [{ documentName: '', documentNumber: '', documentPicture: null }]
    });

    const getCurrentTimestamp = () => {
        const now = new Date();
        return now.toLocaleString('en-US', {
            weekday: 'short',
            month: 'short',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZoneName: 'short'
        });
    };

    // Duplicate Check Logic
    const [similarContacts, setSimilarContacts] = useState([]);
    const [activeField, setActiveField] = useState(null); // 'name', 'phone-0', 'email-0'

    useEffect(() => {
        if (!isOpen) return;

        const nameQuery = formData.name.trim().toLowerCase();
        const surnameQuery = formData.surname.trim().toLowerCase();
        const phones = formData.phones || [];
        const emails = formData.emails || [];

        // Always search based on content, regardless of field focus, for side panel
        if (nameQuery.length > 2 || phones.some(p => p.number?.length > 2) || emails.some(e => e.address?.length > 2)) {
            let matches = [];

            // Check Name
            if (nameQuery.length > 2) {
                matches = [...matches, ...MOCK_CONTACTS.filter(c =>
                    c.name.toLowerCase().includes(nameQuery) ||
                    (c.surname && c.surname.toLowerCase().includes(nameQuery))
                )];
            }

            // Check Phones
            const phoneQueries = phones.filter(p => p.number && p.number.length > 2).map(p => p.number);
            if (phoneQueries.length > 0) {
                matches = [...matches, ...MOCK_CONTACTS.filter(c =>
                    c.phones.some(p => phoneQueries.some(q => p.phoneNumber.includes(q)))
                )];
            }

            // Check Emails
            const emailQueries = emails.filter(e => e.address && e.address.length > 2).map(e => e.address.toLowerCase());
            if (emailQueries.length > 0) {
                matches = [...matches, ...MOCK_CONTACTS.filter(c =>
                    c.emails.some(e => emailQueries.some(q => e.toLowerCase().includes(q)))
                )];
            }

            // Unique by name+phone (simple dedup for display)
            const uniqueMatches = Array.from(new Set(matches.map(m => m.name + m.phones[0].phoneNumber)))
                .map(id => matches.find(m => m.name + m.phones[0].phoneNumber === id));

            setSimilarContacts(uniqueMatches);
        } else {
            setSimilarContacts([]);
        }
    }, [formData.name, formData.phones, formData.emails, isOpen]);

    const handlePopulateForm = (contact) => {
        setFormData(prev => ({
            ...prev,
            title: contact.title || prev.title,
            name: contact.name || prev.name,
            surname: contact.surname || prev.surname,
            company: contact.company || prev.company,
            phones: contact.phones && contact.phones.length > 0 ? contact.phones.map(p => ({ number: p.phoneNumber, type: 'Personal' })) : prev.phones,
            emails: contact.emails && contact.emails.length > 0 ? contact.emails.map(e => ({ address: e, type: 'Personal' })) : prev.emails,
            personalAddress: { ...prev.personalAddress, ...(contact.personalAddress || {}) }
        }));
        setSimilarContacts([]); // Close popup after update
        setActiveField(null);
    };

    const handleInputChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
    };

    const handlePhoneChange = (index, field, value) => {
        const newPhones = [...formData.phones];
        newPhones[index][field] = value;
        setFormData(prev => ({ ...prev, phones: newPhones }));
    };

    const addPhone = () => {
        setFormData(prev => ({
            ...prev,
            phones: [...prev.phones, { number: '', type: 'Personal' }]
        }));
    };

    const handleEmailChange = (index, field, value) => {
        const newEmails = [...formData.emails];
        newEmails[index][field] = value;
        setFormData(prev => ({ ...prev, emails: newEmails }));
    };

    const addEmail = () => {
        setFormData(prev => ({
            ...prev,
            emails: [...prev.emails, { address: '', type: 'Personal' }]
        }));
    };

    const removePhone = (index) => {
        if (formData.phones.length > 1) {
            setFormData(prev => ({
                ...prev,
                phones: prev.phones.filter((_, i) => i !== index)
            }));
        }
    };

    const removeEmail = (index) => {
        if (formData.emails.length > 1) {
            setFormData(prev => ({
                ...prev,
                emails: prev.emails.filter((_, i) => i !== index)
            }));
        }
    };

    // Loan handlers
    const handleLoanChange = (index, field, value) => {
        const newLoans = [...formData.loans];
        newLoans[index][field] = value;
        setFormData(prev => ({ ...prev, loans: newLoans }));
    };

    const addLoan = () => {
        setFormData(prev => ({
            ...prev,
            loans: [...prev.loans, { loanType: '', bank: '', loanAmount: '' }]
        }));
    };

    const removeLoan = (index) => {
        if (formData.loans.length > 1) {
            setFormData(prev => ({
                ...prev,
                loans: prev.loans.filter((_, i) => i !== index)
            }));
        }
    };

    // Social Media handlers
    const handleSocialChange = (index, field, value) => {
        const newSocial = [...formData.socialMedia];
        newSocial[index][field] = value;
        setFormData(prev => ({ ...prev, socialMedia: newSocial }));
    };

    const addSocial = () => {
        setFormData(prev => ({
            ...prev,
            socialMedia: [...prev.socialMedia, { platform: '', url: '' }]
        }));
    };

    const removeSocial = (index) => {
        if (formData.socialMedia.length > 1) {
            setFormData(prev => ({
                ...prev,
                socialMedia: prev.socialMedia.filter((_, i) => i !== index)
            }));
        }
    };

    // Income handlers
    const handleIncomeChange = (index, field, value) => {
        const newIncomes = [...formData.incomes];
        newIncomes[index][field] = value;
        setFormData(prev => ({ ...prev, incomes: newIncomes }));
    };

    const addIncome = () => {
        setFormData(prev => ({
            ...prev,
            incomes: [...prev.incomes, { range: '', amount: '' }]
        }));
    };

    const removeIncome = (index) => {
        if (formData.incomes.length > 1) {
            setFormData(prev => ({
                ...prev,
                incomes: prev.incomes.filter((_, i) => i !== index)
            }));
        }
    };

    // Education handlers
    const handleEducationChange = (index, field, value) => {
        const newEducations = [...formData.educations];
        newEducations[index][field] = value;
        setFormData(prev => ({ ...prev, educations: newEducations }));
    };

    const addEducation = () => {
        setFormData(prev => ({
            ...prev,
            educations: [...prev.educations, { education: '', degree: '', school: '' }]
        }));
    };

    const removeEducation = (index) => {
        if (formData.educations.length > 1) {
            setFormData(prev => ({
                ...prev,
                educations: prev.educations.filter((_, i) => i !== index)
            }));
        }
    };

    // Address handlers
    const handlePersonalAddressChange = (field, value) => {
        setFormData(prev => ({
            ...prev,
            personalAddress: { ...prev.personalAddress, [field]: value }
        }));
    };

    const handleCorrespondenceAddressChange = (field, value) => {
        setFormData(prev => ({
            ...prev,
            correspondenceAddress: { ...prev.correspondenceAddress, [field]: value }
        }));
    };


    // Tag handlers
    const handleTagKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (tagInput.trim()) {
                if (!formData.tags.includes(tagInput.trim())) {
                    setFormData(prev => ({
                        ...prev,
                        tags: [...prev.tags, tagInput.trim()]
                    }));
                }
                setTagInput('');
            }
        }
    };

    const removeTag = (index) => {
        setFormData(prev => ({
            ...prev,
            tags: prev.tags.filter((_, i) => i !== index)
        }));
    };

    const handleDocumentChange = (index, field, value) => {
        const newDocuments = [...formData.documents];
        newDocuments[index][field] = value;
        setFormData(prev => ({ ...prev, documents: newDocuments }));
    };

    const handleDocumentUpload = (index, event) => {
        const file = event.target.files[0];
        if (file) {
            const newDocuments = [...formData.documents];
            newDocuments[index].documentPicture = file;
            setFormData(prev => ({ ...prev, documents: newDocuments }));
        }
    };

    const addDocument = () => {
        setFormData(prev => ({
            ...prev,
            documents: [...prev.documents, { documentNo: '', documentName: '', documentPicture: null }]
        }));
    };

    const removeDocument = (index) => {
        const newDocuments = formData.documents.filter((_, i) => i !== index);
        setFormData(prev => ({ ...prev, documents: newDocuments }));
    };

    const handleCompanySelect = (company) => {
        setFormData(prev => ({ ...prev, company }));
        setCompanySearch(company);
        setShowCompanyDropdown(false);
    };

    const handleNext = () => {
        if (showOnlyRequired) return;

        if (currentTab === 'basic') {
            if (entityType === 'lead') return; // Last tab for lead
            else setCurrentTab('personal');
        }
        else if (currentTab === 'requirement') {
            if (entityType === 'lead') setCurrentTab('location');
            else setCurrentTab('personal');
        }
        else if (currentTab === 'location') setCurrentTab('basic');
        else if (currentTab === 'personal') setCurrentTab('other');
        else if (currentTab === 'other') setCurrentTab('contactDetails');
    };

    const handlePrev = () => {
        if (showOnlyRequired) return;

        if (currentTab === 'contactDetails') setCurrentTab('other');
        else if (currentTab === 'other') setCurrentTab('personal');
        else if (currentTab === 'personal') setCurrentTab('basic');
        else if (currentTab === 'basic') {
            if (entityType === 'lead') setCurrentTab('location');
        }
        else if (currentTab === 'location') setCurrentTab('requirement');
        else if (currentTab === 'requirement') setCurrentTab('basic');
    };

    const handleSave = () => {
        handleSubmit();
    };

    const [unitInput, setUnitInput] = useState('');

    const handleUnitKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = unitInput.trim();
            if (val) {
                // Determine current propertyNo state (ensure array)
                const currentUnits = Array.isArray(formData.propertyNo) ? formData.propertyNo : [];
                if (!currentUnits.includes(val)) {
                    setFormData(prev => ({ ...prev, propertyNo: [...currentUnits, val] }));
                }
                setUnitInput('');
            }
        }
    };

    const removeUnit = (indexToRemove) => {
        setFormData(prev => ({
            ...prev,
            propertyNo: (Array.isArray(prev.propertyNo) ? prev.propertyNo : []).filter((_, index) => index !== indexToRemove)
        }));
    };

    const handleSubmit = () => {
        // Validation
        if (!formData.name) {
            alert('Please enter Name');
            return;
        }
        if (!formData.phones[0].number) {
            alert('Please enter Mobile Number');
            return;
        }
        if (!formData.emails[0].address) {
            alert('Please enter Email Address');
            return;
        }

        onAdd(formData);

        // Reset form
        setFormData({
            title: '', name: '', surname: '', fatherHusbandName: '', countryCode: '+91',
            phones: [{ number: '', type: 'Personal' }],
            emails: [{ address: '', type: 'Personal' }],
            tags: [], description: '',
            professionCategory: '', professionSubCategory: '',
            designation: '', company: '',
            source: '', subSource: '', campaign: '', team: '', owner: '', visibleTo: '',
            requirement: 'Buy', propertyType: [], purpose: 'End use', nri: false,
            subType: [], unitType: [], budgetMin: '', budgetMax: '', areaMin: '', areaMax: '', areaMetric: 'Sq Yard',
            searchLocation: '', streetAddress: '', range: 'Within 3 km', locCity: '', locArea: '', locBlock: [], projectName: [], locPinCode: '',
            locCountry: '', locState: '', locLat: '', locLng: '', facing: [], roadWidth: [], direction: [], funding: '', timeline: '',
            furnishing: '', propertyUnitType: [], transactionType: '', transactionFlexiblePercent: 50, sendMatchedDeal: [],
            personalAddress: { hNo: '', country: '', state: '', city: '', tehsil: '', postOffice: '', pinCode: '', location: '', area: '' },
            correspondenceAddress: { hNo: '', country: '', state: '', city: '', tehsil: '', postOffice: '', pinCode: '', location: '', area: '' },
            gender: '', maritalStatus: '', birthDate: '', anniversaryDate: '',
            educations: [{ education: '', degree: '', school: '' }],
            loans: [{ loanType: '', bank: '', loanAmount: '' }],
            socialMedia: [{ platform: '', url: '' }],
            incomes: [{ incomeType: '', amount: '' }],
            documentNo: '', documentName: '', documentPicture: null,
            specificUnitType: 'single', propertyNo: [], propertyNoEnd: ''
        });
        setUnitInput('');
        setCurrentTab('basic');
    };

    if (!isOpen) return null;

    // --- Premium Styles ---
    // --- Compact / AddUser-like Styles ---
    const overlayStyle = {
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000
    };

    const hasDuplicates = similarContacts && similarContacts.length > 0;

    const modalStyle = {
        background: '#ffffff',
        width: hasDuplicates ? '1150px' : '800px', // Swiches between fixed widths
        maxWidth: '95vw',
        height: showOnlyRequired ? 'auto' : '85vh', // Auto height for compact mode
        maxHeight: '90vh', // Prevent overflow on small screens
        borderRadius: '16px',
        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
        display: 'flex',
        flexDirection: 'row', // Horizontal Layout
        position: 'relative',
        overflow: 'hidden',
        transition: 'width 0.3s ease' // Smooth transition for the modal container
    };

    const leftPaneStyle = {
        width: '800px', // LOCKED Width -> Form never resizes
        flex: 'none',   // Prevent flex growing/shrinking
        display: 'flex',
        flexDirection: 'column',
        height: '100%',
        borderRight: hasDuplicates ? '1px solid #f1f5f9' : 'none',
        transition: 'border-right 0.3s ease'
    };

    const rightPaneStyle = {
        width: '350px', // Fixed sidebar width
        flex: 'none',
        background: '#f8fafc',
        display: hasDuplicates ? 'flex' : 'none',
        flexDirection: 'column',
        height: '100%',
        overflowY: 'auto',
        opacity: hasDuplicates ? 1 : 0,
        transition: 'opacity 0.2s ease',
        transitionDelay: hasDuplicates ? '0.1s' : '0s' // Delay fade-in slightly
    };

    // Removed "Card" styling completely. Just spacing.
    const sectionCardStyle = {
        marginBottom: '24px'
    };

    const sectionTitleStyle = {
        fontSize: '1rem',
        fontWeight: '700',
        color: '#0f172a', // Darker, simpler
        marginBottom: '16px',
        borderBottom: '1px solid #f1f5f9',
        paddingBottom: '8px'
    };

    const labelStyle = {
        display: 'block',
        fontSize: '0.85rem',
        fontWeight: '600',
        color: '#1e293b',
        marginBottom: '4px'
    };

    const inputStyle = {
        width: '100%',
        padding: '8px 12px',
        borderRadius: '6px',
        border: '1px solid #e2e8f0',
        fontSize: '0.9rem',
        color: '#0f172a',
        height: '38px',
        boxSizing: 'border-box',
        backgroundColor: '#fff',
        marginTop: '2px', // Slight gap from label
        outline: 'none',
        transition: 'border-color 0.15s'
    };



    const tabStyle = (isActive) => ({
        padding: '8px 24px',
        fontSize: '0.9rem',
        fontWeight: 600,
        color: isActive ? '#0284c7' : '#64748b', // Blue-600 active, Slate-500 inactive
        backgroundColor: isActive ? '#fff' : 'transparent',
        border: isActive ? '1px solid #bfdbfe' : '1px solid transparent', // Blue-200 active
        borderRadius: '20px',
        cursor: 'pointer',
        transition: 'all 0.2s',
        marginBottom: '0px',
        boxShadow: isActive ? '0 1px 2px 0 rgba(0, 0, 0, 0.05)' : 'none'
    });

    const buttonStyle = {
        primary: {
            background: '#0284c7', // Sky-600
            color: '#fff',
            border: 'none',
            padding: '8px 24px',
            borderRadius: '6px',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '0.85rem'
        },
        secondary: {
            background: '#fff',
            color: '#0f172a',
            border: '1px solid #cbd5e1',
            padding: '8px 24px',
            borderRadius: '6px',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '0.85rem'
        },
        cancel: {
            background: '#fff',
            color: '#ef4444', // Red for cancel to be distinct but still white bg
            border: '1px solid #fca5a5',
            padding: '8px 24px',
            borderRadius: '6px',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '0.85rem'
        },
        success: {
            background: '#0284c7', // Sky-600 (Matching Theme)
            color: '#fff',
            border: 'none',
            padding: '8px 24px',
            borderRadius: '6px',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '0.85rem',
            boxShadow: '0 4px 6px -1px rgba(2, 132, 199, 0.4)'
        }
    };

    return (
        <div style={overlayStyle}>
            <style>
                {`
                    .no-scrollbar::-webkit-scrollbar { display: none; }
                    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                `}
            </style>
            <div style={modalStyle}>
                {/* Left Pane - Form Content */}
                <div style={leftPaneStyle}>
                    {/* Header - Compact Style */}
                    <div style={{ padding: '20px 24px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', flexDirection: 'column' }}>
                            <h2 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 700, color: '#0f172a' }}>
                                {mode === 'edit'
                                    ? `Update ${entityType === 'lead' ? 'Lead' : 'Contact'}`
                                    : `Add ${entityType === 'lead' ? 'Lead' : 'Contact'}`}
                            </h2>
                            <span style={{ fontSize: '0.8rem', color: '#64748b', marginTop: '2px', fontWeight: 500 }}>
                                {currentTime.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })} | {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                            </span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <input
                                type="checkbox"
                                id="showRequired"
                                checked={showOnlyRequired}
                                onChange={(e) => {
                                    setShowOnlyRequired(e.target.checked);
                                    if (e.target.checked) setCurrentTab('basic');
                                }}
                                style={{ width: '16px', height: '16px', accentColor: '#0f172a', cursor: 'pointer' }}
                            />
                            <label htmlFor="showRequired" style={{ fontSize: '0.85rem', color: '#475569', margin: 0, cursor: 'pointer', fontWeight: 500 }}>
                                Show required fields only
                            </label>
                        </div>
                    </div>

                    {/* Tabs - Segmented Control */}
                    <div style={{ padding: '16px 32px 0 32px', background: '#fff' }}>
                        <div style={{
                            display: 'flex',
                            gap: '8px',
                            padding: '4px',
                            background: '#f1f5f9', // Slate-100 pill container
                            borderRadius: '9999px',
                            width: 'fit-content'
                        }}>
                            {entityType === 'lead' ? (
                                <>
                                    <button
                                        onClick={() => setCurrentTab('requirement')}
                                        style={tabStyle(currentTab === 'requirement')}
                                    >
                                        Requirement
                                    </button>
                                    <button
                                        onClick={() => setCurrentTab('location')}
                                        style={tabStyle(currentTab === 'location')}
                                    >
                                        Location
                                    </button>
                                    <button
                                        onClick={() => setCurrentTab('basic')}
                                        style={tabStyle(currentTab === 'basic')}
                                    >
                                        Contact Details
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={() => setCurrentTab('basic')}
                                        style={tabStyle(currentTab === 'basic')}
                                    >
                                        Basic
                                    </button>
                                    {!showOnlyRequired && (
                                        <>
                                            <button
                                                onClick={() => setCurrentTab('personal')}
                                                style={tabStyle(currentTab === 'personal')}
                                            >
                                                Personal
                                            </button>
                                            <button
                                                onClick={() => setCurrentTab('other')}
                                                style={tabStyle(currentTab === 'other')}
                                            >
                                                Other
                                            </button>
                                            <button
                                                onClick={() => setCurrentTab('contactDetails')}
                                                style={tabStyle(currentTab === 'contactDetails')}
                                            >
                                                Contact Details
                                            </button>
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                    </div>

                    {/* Body - Slate Background for Contrast */}
                    <div className="no-scrollbar" style={{ padding: '24px', overflowY: 'auto', flex: 1, background: '#f8fafc', paddingBottom: '40px' }}>
                        {currentTab === 'basic' ? (
                            <div>
                                <div style={{ padding: '20px' }}>Basic Tab Debugging...</div>
                            </div>) : currentTab === 'requirement' ? (
                                <div className="no-scrollbar" style={{ padding: '20px' }}>
                                    Requirement Tab Debugging...
                                </div>
                            ) : currentTab === 'location' ? (
                                <div>
                                    <div style={{ padding: '20px' }}>Location Tab Debugging...</div>
                                </div>
                            ) : currentTab === 'personal' ? (
                                <div style={{padding: '20px', color: '#666'}}>Personal Tab Debugging...</div>
                            ) : currentTab === 'other' ? (
                                <div style={{padding: '20px', color: '#666'}}>Other Tab Debugging...</div>
                            ) : currentTab === 'contactDetails' ? (
                                <div style={{padding: '20px', color: '#666'}}>ContactDetails Tab Debugging...</div>
                            ) : null}
                    </div>



                    {/* Footer - Compact Gray Style */}
                    <div style={{ padding: '16px 24px', borderTop: '1px solid #f1f5f9', background: '#f8fafc', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>

                        {/* Left Side: Cancel */}
                        <button
                            onClick={onClose}
                            style={buttonStyle.cancel}
                        >
                            Cancel
                        </button>

                        {/* Right Side: Navigation */}
                        <div style={{ display: 'flex', gap: '12px' }}>
                            {currentTab !== 'basic' && (
                                <button
                                    onClick={handlePrev}
                                    style={buttonStyle.secondary}
                                >
                                    Previous
                                </button>
                            )}
                            {((entityType === 'lead' && currentTab !== 'basic') || (entityType !== 'lead' && currentTab !== 'contactDetails')) && !showOnlyRequired ? (
                                <button
                                    onClick={handleNext}
                                    style={buttonStyle.primary}
                                >
                                    Next
                                </button>
                            ) : (
                                <button
                                    onClick={handleSave}
                                    style={buttonStyle.success}
                                >
                                    Save
                                </button>
                            )}
                        </div>
                    </div>
                </div >


                {/* Right Side Pane - Duplicate Suggestions */}
                < div style={rightPaneStyle} >
                    <div style={{
                        padding: '20px 24px',
                        borderBottom: '1px solid #e2e8f0',
                        background: '#fff',
                        marginBottom: '1px'
                    }}>
                        <h3 style={{ margin: 0, fontSize: '1rem', fontWeight: 700, color: '#334155' }}>
                            Suggestions
                        </h3>
                        <p style={{ margin: '4px 0 0 0', fontSize: '0.8rem', color: '#64748b' }}>
                            Possible duplicates based on input
                        </p>
                    </div>
                    <div style={{ flex: 1, overflowY: 'auto' }}>
                        <DuplicateResults contacts={similarContacts} onUpdate={handlePopulateForm} />
                    </div>
                </div >

            </div >
        </div >
    );
};

export default AddContactModal;
